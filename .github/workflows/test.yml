name: Test

on:
  push:
    branches: [ main, develop ]
  workflow_call:

env:
  BUILD_TYPE: Debug
  CXX_STANDARD: 17

jobs:
  # Unit and Integration Tests
  unit-tests:
    name: Unit Tests (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    needs: []
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 22.04: GCC 11 and Clang 14
          - os: ubuntu-22.04
            compiler: gcc
            cc: gcc-11
            cxx: g++-11
            boost_version: "1.74"
          - os: ubuntu-22.04
            compiler: clang
            cc: clang-14
            cxx: clang++-14
            boost_version: "1.74"
          # Ubuntu 24.04: GCC 13 and Clang 15
          - os: ubuntu-24.04
            compiler: gcc
            cc: gcc-13
            cxx: g++-13
            boost_version: "1.83"
          - os: ubuntu-24.04
            compiler: clang
            cc: clang-15
            cxx: clang++-15
            boost_version: "1.83"
          # macOS: Clang
          - os: macos-14
            compiler: clang
            cc: clang
            cxx: clang++
            boost_version: "1.83"

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Compute CMakeLists hash
      id: cmake-hash
      run: |
        FILES=$(git ls-files '**/CMakeLists.txt')
        if [ -z "$FILES" ]; then
          echo "hash=none" >> "$GITHUB_OUTPUT"
        else
          HASH=$(printf '%s\n' "$FILES" | LC_ALL=C sort | xargs shasum | shasum | awk '{print $1}')
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
        fi

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-${{ runner.os }}-${{ matrix.os }}-${{ matrix.compiler }}-${{ steps.cmake-hash.outputs.hash }}

    - name: Install dependencies
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ccache

          # Install Boost (version-specific per OS)
          if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
            sudo apt-get install -y libboost1.74-dev libboost-system1.74-dev
          else
            # ubuntu-24.04: try 1.83 first, fallback to 1.74
            if ! sudo apt-get install -y libboost1.83-dev libboost-system1.83-dev; then
              echo "Boost 1.83 not available, installing 1.74..."
              sudo apt-get install -y libboost1.74-dev libboost-system1.74-dev
            fi
          fi
        else
          brew update
          brew install cmake ccache boost

          # Ensure ccache shims are on PATH for clang on both Intel and Apple Silicon
          echo "PATH=/opt/homebrew/opt/ccache/libexec:/usr/local/opt/ccache/libexec:$PATH" >> $GITHUB_ENV
        fi
       
    - name: Detect CPU core count
      run: |
        CORES=$( (command -v nproc >/dev/null 2>&1 && nproc) || sysctl -n hw.logicalcpu || getconf _NPROCESSORS_ONLN || echo 4 )
        echo "CORE_COUNT=$CORES" >> $GITHUB_ENV
       
    - name: Configure CMake
      run: |
        cmake -S . -B build-test \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} \
          -DUNILINK_ENABLE_CONFIG=ON \
          -DUNILINK_BUILD_EXAMPLES=OFF \
          -DUNILINK_BUILD_DOCS=OFF \
          -DUNILINK_BUILD_TESTS=ON \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build tests
      run: cmake --build build-test -j ${CORE_COUNT:-4}

    - name: Run unit tests
      run: |
        cd build-test
        ctest --output-on-failure --parallel ${CORE_COUNT:-2} \
          --label-regex "unit|core|memory|config" || \
        ctest --rerun-failed --output-on-failure --parallel ${CORE_COUNT:-2}

    - name: Upload test results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: unit-test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: build-test/Testing/
        retention-days: 7
        overwrite: true

  # Integration Tests
  integration-tests:
    name: Integration Tests (ubuntu-22.04, gcc)
    runs-on: ubuntu-22.04
    needs: []

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-${{ runner.os }}-integration-${{ hashFiles('**/CMakeLists.txt') }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ccache \
          gcc-11 g++-11 \
          libboost1.74-dev libboost-system1.74-dev

    - name: Configure CMake
      run: |
        cmake -S . -B build-integration \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} \
          -DUNILINK_ENABLE_CONFIG=ON \
          -DUNILINK_BUILD_EXAMPLES=OFF \
          -DUNILINK_BUILD_DOCS=OFF \
          -DUNILINK_BUILD_TESTS=ON \
          -DUNILINK_ENABLE_PERFORMANCE_TESTS=OFF \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build integration tests
      run: cmake --build build-integration -j $(nproc)

    - name: Run integration tests
      run: |
        cd build-integration
        ctest --output-on-failure --parallel 2 \
          --label-regex "integration|mock|stable" \
          --label-exclude "slow" || \
        ctest --rerun-failed --output-on-failure --parallel 2 \
          --label-regex "integration|mock|stable" \
          --label-exclude "slow"

    - name: Upload integration test results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: integration-test-results
        path: build-integration/Testing/
        retention-days: 7
        overwrite: true

  # Performance Tests
  performance-tests:
    name: Performance Tests (ubuntu-22.04, gcc)
    runs-on: ubuntu-22.04
    needs: []

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-${{ runner.os }}-performance-${{ hashFiles('**/CMakeLists.txt') }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ccache \
          gcc-11 g++-11 \
          libboost1.74-dev libboost-system1.74-dev

    - name: Configure CMake
      run: |
        cmake -S . -B build-perf \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} \
          -DUNILINK_ENABLE_CONFIG=ON \
          -DUNILINK_BUILD_EXAMPLES=OFF \
          -DUNILINK_BUILD_DOCS=OFF \
          -DUNILINK_BUILD_TESTS=ON \
          -DUNILINK_ENABLE_PERFORMANCE_TESTS=ON \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

    - name: Build performance tests
      run: cmake --build build-perf -j $(nproc)

    - name: Run performance tests
      run: |
        cd build-perf
        ctest --output-on-failure --parallel 2 \
          --label-regex "performance|benchmark|stress"

    - name: Upload performance test results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: performance-test-results
        path: build-perf/Testing/
        retention-days: 7
        overwrite: true

  # Memory Safety Tests
  memory-safety-tests:
    name: Memory Safety Tests
    runs-on: ubuntu-22.04
    needs: []

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          gcc-11 \
          g++-11 \
          libboost1.74-dev \
          libboost-system1.74-dev \
          clang \
          libc++-dev \
          libc++abi-dev

    - name: Configure CMake with Sanitizers
      run: |
        cmake -S . -B build-sanitizer \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_COMPILER=clang \
          -DUNILINK_ENABLE_SANITIZERS=ON \
          -DUNILINK_ENABLE_MEMORY_TRACKING=ON \
          -DUNILINK_BUILD_TESTS=ON \
          -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined,leak -fno-omit-frame-pointer -g" \
          -DCMAKE_C_FLAGS="-fsanitize=address,undefined,leak -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined,leak" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined,leak"

    - name: Build with sanitizers
      run: cmake --build build-sanitizer -j $(nproc)

    - name: Run memory safety tests
      run: |
        cd build-sanitizer
        ctest --output-on-failure --parallel $(nproc) \
          --label-regex "memory|safety"

    - name: Upload memory safety test results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: memory-safety-test-results
        path: build-sanitizer/Testing/
        retention-days: 7
        overwrite: true

  # Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    needs: [unit-tests, integration-tests, performance-tests, memory-safety-tests]
    if: always()

    steps:
    - name: Test Summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Memory Safety Tests | ${{ needs.memory-safety-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
