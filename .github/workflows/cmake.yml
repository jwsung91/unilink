name: CMake

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 50
    strategy:
      fail-fast: false
      matrix:
        include:
          # Matrix for Pure C++ (existing configuration)
          - name: Pure C++ (Linux, GCC)
            os: ubuntu-24.04
            cc: gcc
            cxx: g++
            generator: Ninja
            build_type: Release
            build_python: OFF
          - name: Pure C++ (Windows, MSVC)
            os: windows-2022
            cc: cl
            cxx: cl
            generator: "Visual Studio 17 2022"
            build_type: Release
            build_python: OFF
          - name: Pure C++ (macOS, Clang)
            os: macos-14
            cc: clang
            cxx: clang++
            generator: Ninja
            build_type: Release
            build_python: OFF

          # Matrix for Python Enabled
          - name: With Python (Linux, GCC)
            os: ubuntu-24.04
            cc: gcc
            cxx: g++
            generator: Ninja
            build_type: Release
            build_python: ON
          - name: With Python (Windows, MSVC)
            os: windows-2022
            cc: cl
            cxx: cl
            generator: "Visual Studio 17 2022"
            build_type: Release
            build_python: ON
          - name: With Python (macOS, Clang)
            os: macos-14
            cc: clang
            cxx: clang++
            generator: Ninja
            build_type: Release
            build_python: ON

    env:
      BUILD_TYPE: ${{ matrix.build_type }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Build Dependencies (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y ninja-build autoconf autoconf-archive automake libtool libtool-bin pkg-config libboost-all-dev
          else
            brew install ninja autoconf autoconf-archive automake libtool pkg-config boost
          fi

      - name: Setup Python
        if: matrix.build_python == 'ON'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set Boost Root (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ($env:BOOST_ROOT_1_83_0) {
            echo "BOOST_ROOT=$env:BOOST_ROOT_1_83_0" >> $env:GITHUB_ENV
          } elseif ($env:BOOST_ROOT_1_72_0) {
            echo "BOOST_ROOT=$env:BOOST_ROOT_1_72_0" >> $env:GITHUB_ENV
          } else {
             echo "BOOST_ROOT=C:\hostedtoolcache\windows\Boost\1.83.0\x86_64" >> $env:GITHUB_ENV
          }

      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cmake -S . -B build \
            -G "${{ matrix.generator }}" \
            -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" \
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" \
            -DUNILINK_BUILD_EXAMPLES=OFF \
            -DUNILINK_BUILD_DOCS=OFF \
            -DUNILINK_BUILD_TESTS=ON \
            -DUNILINK_ENABLE_PERFORMANCE_TESTS=OFF \
            -DBUILD_PYTHON_BINDINGS=${{ matrix.build_python }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "${{ matrix.generator }}" -A x64 `
            -DCMAKE_BUILD_TYPE="${env:BUILD_TYPE}" `
            -DUNILINK_BUILD_EXAMPLES=OFF `
            -DUNILINK_BUILD_DOCS=OFF `
            -DUNILINK_BUILD_TESTS=ON `
            -DUNILINK_ENABLE_PERFORMANCE_TESTS=OFF `
            -DBUILD_PYTHON_BINDINGS=${{ matrix.build_python }}

      - name: Build
        run: cmake --build build --config "${BUILD_TYPE}" --parallel

      - name: Build unit tests
        if: runner.os == 'Windows'
        run: cmake --build build --target unilink_unit_tests --config "${BUILD_TYPE}"

      - name: Test (Windows)
        if: runner.os == 'Windows'
        working-directory: build
        shell: pwsh
        run: ctest -C "${env:BUILD_TYPE}" --output-on-failure

      - name: Test (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: build
        run: ctest --output-on-failure --parallel 2

      - name: Verify Python Import
        if: matrix.build_python == 'ON'
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            export PYTHONPATH="$PWD/build/${BUILD_TYPE}:$PYTHONPATH"
          else
            export PYTHONPATH="$PWD/build:$PWD/build/lib:$PYTHONPATH"
          fi
          python3 bindings/python/test_import.py
