name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        default: 'v0.1.0-test'

jobs:
  create-release:
    name: Build and Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      NONINTERACTIVE: 1
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            label: Linux (Ubuntu 24.04)
            cmake_generator: "Ninja"
            cpack_generator: "TGZ"
            release_files: |
              build/package/unilink-*.tar.gz

          - os: macos-14
            label: macOS 14
            cmake_generator: "Ninja"
            cpack_generator: "TGZ;DragNDrop"
            release_files: |
              build/package/unilink-*.tar.gz
              build/package/unilink-*.dmg

          - os: windows-latest
            label: Windows (VS 2022)
            cmake_generator: "Visual Studio 17 2022"
            cmake_arch: "x64"
            cpack_generator: "ZIP"
            release_files: |
              build/package/unilink-*.zip
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up C++ toolchain (Linux)
        if: runner.os == 'Linux'
        run: |
          # Remove problematic Microsoft repository to avoid 421 Misdirected Request error
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get update --allow-releaseinfo-change
          sudo apt-get install -y build-essential cmake ninja-build libboost-all-dev

      - name: Set up C++ toolchain (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja boost

      - name: Prepare Keychain (macOS)
        if: runner.os == 'macOS'
        run: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Set up C++ toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja --no-progress -y
          & "C:\vcpkg\vcpkg.exe" install boost-asio:x64-windows boost-system:x64-windows

      - name: Configure
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            cmake -S . -B build -G "${{ matrix.cmake_generator }}" -A "${{ matrix.cmake_arch }}" \
              -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" \
              -DVCPKG_TARGET_TRIPLET=x64-windows \
              -DUNILINK_ENABLE_INSTALL=ON \
              -DUNILINK_ENABLE_PKGCONFIG=ON \
              -DUNILINK_ENABLE_EXPORT_HEADER=ON
          else
            cmake -S . -B build -G "${{ matrix.cmake_generator }}" \
              -DCMAKE_BUILD_TYPE=Release \
              -DUNILINK_ENABLE_INSTALL=ON \
              -DUNILINK_ENABLE_PKGCONFIG=ON \
              -DUNILINK_ENABLE_EXPORT_HEADER=ON
          fi

      - name: Build
        shell: bash
        run: |
          BUILD_ARGS="--config Release --verbose"
          if [ "${{ runner.os }}" = "macOS" ]; then
            # Explicitly use all available cores as requested for optimization
            CORES=$(sysctl -n hw.ncpu)
            BUILD_ARGS="$BUILD_ARGS --parallel $CORES"
          else
            # Rely on CMake/Generator default parallelism for other platforms
            BUILD_ARGS="$BUILD_ARGS --parallel"
          fi
          echo "Building with args: $BUILD_ARGS"
          cmake --build build $BUILD_ARGS

      - name: Test
        shell: bash
        run: ctest --test-dir build --output-on-failure -C Release

      - name: Package
        shell: bash
        run: |
          cd build
          cpack -C Release -B package -G "${{ matrix.cpack_generator }}"
          ls -la package/

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.release_files }}
          name: Release ${{ github.ref_name || inputs.tag_name }} (${{ matrix.label }})
          tag_name: ${{ github.ref_name || inputs.tag_name }}
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
