name: Build

on:
  push:
    branches: [ main, develop ]
  workflow_call:

env:
  BUILD_TYPE: Release
  CXX_STANDARD: 17

jobs:
  # Multi-platform Build Matrix (Ubuntu 22.04, 24.04)
  build:
    name: Build (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 22.04: GCC 11 and Clang 14
          - os: ubuntu-22.04
            compiler: gcc
            cc: gcc-11
            cxx: g++-11
            boost_version: "1.74"
          - os: ubuntu-22.04
            compiler: clang
            cc: clang-14
            cxx: clang++-14
            boost_version: "1.74"
          # Ubuntu 24.04: GCC 13 and Clang 15
          - os: ubuntu-24.04
            compiler: gcc
            cc: gcc-13
            cxx: g++-13
            boost_version: "1.83"
          - os: ubuntu-24.04
            compiler: clang
            cc: clang-15
            cxx: clang++-15
            boost_version: "1.83"

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        set -e  # Exit on any error
        
        echo "Installing basic dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          doxygen \
          graphviz
        
        echo "Installing compiler: ${{ matrix.compiler }} for ${{ matrix.os }}"
        # Install specific compiler versions
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          if [ "${{ matrix.os }}" = "ubuntu-20.04" ]; then
            sudo apt-get install -y gcc-9 g++-9
          elif [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
            sudo apt-get install -y gcc-11 g++-11
          elif [ "${{ matrix.os }}" = "ubuntu-24.04" ]; then
            sudo apt-get install -y gcc-13 g++-13
          fi
        else
          if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
            sudo apt-get install -y clang-14
          elif [ "${{ matrix.os }}" = "ubuntu-24.04" ]; then
            sudo apt-get install -y clang-15
          fi
        fi
        
        echo "Installing Boost libraries for ${{ matrix.os }}"
        # Ubuntu version-specific Boost installation
        if [ "${{ matrix.os }}" = "ubuntu-20.04" ]; then
          sudo apt-get install -y libboost1.65-dev libboost-system1.65-dev
        elif [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
          sudo apt-get install -y libboost1.74-dev libboost-system1.74-dev
        else
          # Ubuntu 24.04: try 1.83 first, fallback to 1.74
          if ! sudo apt-get install -y libboost1.83-dev libboost-system1.83-dev; then
            echo "Boost 1.83 not available, installing 1.74..."
            sudo apt-get install -y libboost1.74-dev libboost-system1.74-dev
          fi
        fi
        
        echo "Verifying compiler installation..."
        ${{ matrix.cc }} --version
        ${{ matrix.cxx }} --version

    - name: Set up compiler
      run: |
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Configure CMake (Minimal Build)
      run: |
        set -e
        echo "Configuring minimal build..."
        cmake -S . -B build-minimal \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} \
          -DUNILINK_ENABLE_CONFIG=OFF \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTING=ON

    - name: Configure CMake (Full Build)
      run: |
        set -e
        echo "Configuring full build..."
        cmake -S . -B build-full \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} \
          -DUNILINK_ENABLE_CONFIG=ON \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTING=ON

    - name: Build (Minimal)
      run: |
        set -e
        echo "Building minimal version..."
        cmake --build build-minimal -j $(nproc)

    - name: Build (Full)
      run: |
        set -e
        echo "Building full version..."
        cmake --build build-full -j $(nproc)

    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      with:
        name: build-artifacts-${{ matrix.os }}-${{ matrix.compiler }}
        path: |
          build-minimal/
          build-full/
        retention-days: 7
        overwrite: true

  # Windows Build (MSVC + vcpkg)
  build-windows:
    name: Build (windows-2022, msvc)
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Restore vcpkg and install Boost
      uses: microsoft/vcpkg-action@v1
      with:
        triplet: x64-windows
        vcpkgArguments: "boost-system"
        cacheHitVar: VCPKG_CACHE_HIT

    - name: Configure CMake (MSVC + vcpkg)
      shell: pwsh
      run: |
        cmake -S . -B build-windows `
          -G "Ninja" `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_CXX_STANDARD=${{ env.CXX_STANDARD }} `
          -DUNILINK_ENABLE_CONFIG=ON `
          -DUNILINK_BUILD_EXAMPLES=OFF `
          -DUNILINK_BUILD_TESTS=ON `
          -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows

    - name: Build (Release)
      shell: pwsh
      run: cmake --build build-windows --config ${{ env.BUILD_TYPE }}

    - name: Smoke tests (exclude slow/perf)
      shell: pwsh
      run: |
        ctest --test-dir build-windows `
          -C ${{ env.BUILD_TYPE }} `
          --output-on-failure `
          --label-exclude "performance|benchmark|stress|slow|serial"

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: build-artifacts-windows-msvc
        path: |
          build-windows/
        retention-days: 7
        overwrite: true

  # Docker Build
  docker-build:
    name: Docker Build
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: unilink:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm unilink:latest --version || echo "Version check not available"
